# Fun with Letters in PostGIS 3.3!

There are a few new fun functions in PostGIS 3.3 which are worth exploring in this post.

## ST_Letters

First, my colleague at Crunchy Data, Paul Ramsey introduced a function to generate polygons that look like letters! This is objectively really cool and a fun use case for demos. Here's a simple example.

`Select ST_Letters('PostGIS');`
![Alt text](postgis_letters.png)


But it's also possible to overlay letters on a map, just like any other polygon. Since the default for `ST_Letters` results in a polygon starting at the baseline at the origin of the chosen projection, with a maximum height of 100 "units" (from the bottom of the descenders to the tops of the capitals),we need a way to both move it and resize it. For context, this is what the default args look like with the WGS84 projection. 

![Alt text](postgis_letters_unscaled.png)

Not ideal. First, we want to make a point in the middle of San Francisco in order to serve as a centroid for where we want to move the letters, and we also want to rescale the letters in order to approximately fit over the City of San Francisco. Using the formula for convering units in WGS84 to meters, 0.001 works approximately well enough to fit over the San Francisco Bay Area. Next we use `ST_Translate` in order to move the letters from the top of the map to fit over the Bay Area. Finally, mostly because it looks cool, we use `ST_Rotate` to rotate the polygon 45 degrees. 

```
With san_fran_pt AS (Select (ST_Point(-122.48, 37.758, 4326)) AS geom),
letters AS (Select ST_Scale(ST_SetSRID(
                    ST_Letters('San Francisco'), 4326),
                0.001, 0.001) AS geom),

letters_geom AS (
    Select ST_Translate(
            letters.geom,
            ST_X(san_fran_pt.geom) - ST_X(ST_Centroid(letters.geom)),
            ST_Y(san_fran_pt.geom) - ST_Y(ST_Centroid(letters.geom))

        ) AS geom
    FROM letters, san_fran_pt
)
Select ST_Rotate(geom, -pi() / 4, ST_Centroid(geom))
FROM letters_geom;

```

![Alt text](postgis_letters_sf.png)

# ST_ConcaveHull demo'd with ST_Letters

A great use case for `ST_Letters` is for demoing PostGIS functions. In this post, I'm going to demo the function `ST_ConcaveHull`, which creates a concave polygon which encloses the verticies of a target geometry. `ST_ConcaveHull` was recently unpdated in PostGIS 3.3.0, in order to use GEOS 3.11, which makes the input parameters easier to understand and results in a large speed upgrade. Here's a short demo of how different parameters of `param_pctconvex` and `param_allow_holes` for `ST_ConcaveHull` operate on points generated by `ST_GeneratePoints` and `ST_Letters`. 

First, let's generate a table of randomly generated points that fill in the letters in 'postgis'
```
CREATE TABLE public.word_pts AS (
With word as (
	Select ST_Letters('postgis') as geom
	),
	letters as ( -- dump letter multipolygons into individual polygons
	Select ((ST_Dump(word.geom)).geom) 
	 	FROM word
	 		)
Select letters.geom AS polys, ST_GeneratePoints(letters.geom, 100) AS pts FROM
	letters
	);
```

`Select pts FROM word_pts.pts` 

![Alt text](word_pnts.png)

First, we set the convexity to a fairly high parameter (`param_pctconvex=0.75`, indicating a highly convex shape), and don't allow there to be holes in the shape (`param_allow_holes=false`)


`Select ST_ConcaveHull(pts, 0.5, false) FROM word_pts`; 

![Alt text](st_concave_75_false.png)

Doesn't look much like 'postgis'! 

Next, we reduce the convexity, but don't allow holes in the shape. 

`Select ST_ConcaveHull(pts, 0.5, false) FROM word_pts`

![Alt text](st_concave_5_false.png)

A little better, but still hard to recognize 'postgis'. What if we allowed holes?

`Select ST_ConcaveHull(pts, 0.5, true) FROM word_pts`

This starts to look a bit more like the word 'postgis', with the hole in 'p' being clear. 

![Alt text](st_concave_5_true.png)

As we start to make the shape more concave, it begins to take on more and more recognizable as 'postgis'....until it doesn't and starts to look closer to modern art. 

`Select ST_ConcaveHull(pts, 0.35, true) FROM word_pts`

![Alt text](st_concave_35_true.png)

`Select ST_ConcaveHull(pts, 0.05, true) FROM word_pts`

![Alt text](st_concave_005_true.png)

## Polygons too!

`ST_ConcaveHull` is also useful on polygons, and follows the same properties as demo'd on multipoints. It's important to note that if there are already holes in the existing polygon, setting `param_allow_holes=false` will still create convex polygons with "holes" in the middle, following the original polygon. 

`Select ST_ConcaveHull(polys, 0.5, false) FROM word_pts;` 

![Alt text](st_concave_5_false_polys.png)

As the convexity decreases, the shape looks more and more like the original polygons in the original table. 

`Select ST_ConcaveHull(polys, 0.15, true) FROM word_pts;` 

![Alt text](st_concave_005_true_polys.png)




## Summary:

`ST_Letters` is a really useful function for both visualization and demoing how certain geometric functions work in PostGIS, and provides a useful starting point for demoing functions on points and polygons. The new improvements in `ST_ConcaveHull` make it more useful for generating concave hulls of geometries 